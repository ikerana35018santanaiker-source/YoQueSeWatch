<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YoQueSéWatch</title>
    <link rel="shortcut icon" href="https://i.ibb.co/9mRXdkKx/Sin-t-tulo.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Pantalla de autenticación -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <h2 id="authTitle">Iniciar SesiÃ³n</h2>
            <input type="text" id="authUsername" placeholder="Nombre de usuario" />
            <input type="email" id="authEmail" placeholder="Email" />
            <input type="password" id="authPassword" placeholder="ContraseÃ±a" />
            <button class="btn-primary" id="authSubmit">Entrar</button>
            <button class="btn-secondary" id="authToggle">Â¿No tienes cuenta? RegÃ­strate</button>
            <div style="display: flex; align-items: center; margin: 20px 0;">
                <div style="flex: 1; height: 1px; background: #e0e0e0;"></div>
                <span style="padding: 0 10px; color: #999;">o</span>
                <div style="flex: 1; height: 1px; background: #e0e0e0;"></div>
            </div>
            <button class="btn-primary" id="googleLogin" style="background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px; border: 2px solid #e0e0e0;">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continuar con Google
            </button>
        </div>
    </div>

    <!-- Vista de perfil de usuario -->
    <div class="user-profile-view" id="userProfileView">
        <div class="user-profile-header">
            <div class="back-btn" id="closeUserProfile">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
            </div>
            <div class="user-profile-info">
                <img class="user-profile-avatar" id="viewProfileAvatar" src="" alt="Avatar" />
                <div class="user-profile-name" id="viewProfileName">Usuario</div>
                <div class="user-profile-username" id="viewProfileUsername">@usuario</div>
                <div class="user-profile-stats">
                    <div class="stat">
                        <div class="stat-number" id="viewProfileFollowing">0</div>
                        <div class="stat-label">Siguiendo</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="viewProfileFollowers">0</div>
                        <div class="stat-label">Seguidores</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="viewProfileLikes">0</div>
                        <div class="stat-label">Me gusta</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="user-profile-actions">
            <button class="action-button primary" id="followUserBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <line x1="20" y1="8" x2="20" y2="14"></line>
                    <line x1="23" y1="11" x2="17" y2="11"></line>
                </svg>
                Seguir
            </button>
            <button class="action-button secondary" id="chatUserBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                Chatear
            </button>
        </div>
        <div class="user-profile-videos" id="viewProfileVideos"></div>
    </div>

    <!-- Modal de comentarios -->
<div class="modal" id="commentsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="commentsTitle">Comentarios</h2>
            <svg class="close-btn" id="closeComments" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </div>
        
        <div class="comments-list" id="commentsList">
            <div class="loading">Cargando comentarios...</div>
        </div>
        
        <div class="comment-input-wrapper">
            <input type="text" id="commentInput" placeholder="Escribe un comentario..." />
            <button class="send-btn" id="sendComment">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>

    <!-- Videollamada -->
    <div class="video-call-container" id="videoCallContainer">
        <div class="video-call-header">
            <div class="video-call-name" id="videoCallName">Usuario</div>
            <div class="video-call-status" id="videoCallStatus">Conectando...</div>
        </div>
        <div class="video-streams">
            <video class="remote-video" id="remoteVideo" autoplay playsinline></video>
            <video class="local-video" id="localVideo" autoplay playsinline muted></video>
        </div>
        <div class="call-controls">
            <button class="call-btn mute" id="muteBtn">
                <div class="call-btn-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </div>
            </button>
            <button class="call-btn end" id="endCallBtn">
                <div class="call-btn-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        <line x1="23" y1="1" x2="1" y2="23"></line>
                    </svg>
                </div>
            </button>
            <button class="call-btn mute" id="videoToggleBtn">
                <div class="call-btn-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <polygon points="23 7 16 12 23 17 23 7"></polygon>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                    </svg>
                </div>
            </button>
        </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3 id="confirmTitle">¿Estás seguro?</h3>
            <p id="confirmMessage">Esta acción no se puede deshacer.</p>
            <div class="confirm-buttons">
                <button class="btn-cancel" id="confirmCancel">Cancelar</button>
                <button class="btn-danger" id="confirmAccept">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- App principal -->
    <div class="app-container" id="appContainer">
<div class="nav-bar">
    <h1>YoQueSéWatch</h1>
    <div class="nav-icons">
        <svg id="openSearchBtn" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
        <div style="position: relative;">
            <svg id="notificationsBtn" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </div>
    </div>
</div>

<!-- Barra de búsqueda global -->
<div class="global-search-bar" id="globalSearchBar" style="display: none;">
    <div class="search-container">
        <div class="search-tabs">
            <button class="search-tab active" data-tab="users">Usuarios</button>
            <button class="search-tab" data-tab="videos">Videos</button>
        </div>
        <div class="search-input-wrapper">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
            <input type="text" id="globalSearch" placeholder="Buscar..." />
            <svg id="closeGlobalSearch" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="cursor: pointer;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
        <div class="global-search-results" id="globalSearchResults"></div>
    </div>
</div>

<!-- Panel de notificaciones -->
<div class="notifications-panel" id="notificationsPanel" style="display: none;">
    <div class="notifications-header">
        <h3>Notificaciones</h3>
        <svg id="closeNotifications" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="cursor: pointer;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
    <div class="notifications-list" id="notificationsList"></div>
</div>

        <!-- Feed de videos -->
        <div class="video-feed" id="videoFeed">
            <div class="loading">Cargando videos...</div>
        </div>

        <!-- Sección de perfil -->
        <div class="profile-section" id="profileSection">
            <div class="profile-header">
                <img class="profile-avatar" id="profileAvatar" src="" alt="Avatar" />
                <h2 id="profileName">Usuario</h2>
                <p id="profileUsername">@usuario</p>
                <div class="profile-stats">
                    <div class="stat">
                        <div class="stat-number" id="profileFollowing">0</div>
                        <div class="stat-label">Siguiendo</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="profileFollowers">0</div>
                        <div class="stat-label">Seguidores</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="profileLikes">0</div>
                        <div class="stat-label">Me gusta</div>
                    </div>
                </div>
                <button class="follow-btn" id="editProfileBtn">Editar Perfil</button>
            </div>
            <div class="profile-videos" id="profileVideos"></div>
        </div>

        <!-- Sección de amigos -->
        <div class="friends-section" id="friendsSection">
            <div class="search-container">
                <div class="search-bar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                    <input type="text" id="friendsSearch" placeholder="Buscar usuarios..." />
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div id="friendsList"></div>
        </div>

        <!-- Sección de chat -->
        <div class="chat-section" id="chatSection">
            <div class="chat-list" id="chatList"></div>
            <div class="chat-window" id="chatWindow" style="display: none;">
                <div class="messages" id="messages"></div>
                <div class="message-input">
                    <button class="video-call-btn" id="videoCallBtn" title="Videollamada">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <polygon points="23 7 16 12 23 17 23 7"></polygon>
                            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                        </svg>
                    </button>
                    <input type="text" id="messageInput" placeholder="Escribe un mensaje..." />
                    <button class="send-btn" id="sendMessage">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sección de ajustes -->
        <div class="settings-section" id="settingsSection">
            <div class="settings-header">
                <h2>Ajustes</h2>
            </div>
            
            <div class="settings-item" id="accountInfoBtn">
                <div class="settings-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="settings-info">
                    <div class="settings-title">Información de cuenta</div>
                    <div class="settings-description">Ver detalles de tu cuenta</div>
                </div>
            </div>

            <div class="settings-item" id="logoutBtn">
                <div class="settings-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </div>
                <div class="settings-info">
                    <div class="settings-title">Cerrar sesión</div>
                    <div class="settings-description">Salir de tu cuenta</div>
                </div>
            </div>

            <div class="settings-item danger" id="deleteAccountBtn">
                <div class="settings-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
                <div class="settings-info">
                    <div class="settings-title">Eliminar cuenta</div>
                    <div class="settings-description">Borrar permanentemente tu cuenta</div>
                </div>
            </div>
        </div>

        <div class="video-type-selector">
    <button class="video-type-btn active" data-type="short">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect>
        </svg>
        Short (Vertical)
    </button>
    <button class="video-type-btn" data-type="long">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect>
        </svg>
        Long (Horizontal)
    </button>
        </div>

        <!-- Barra de navegación inferior -->
        <!-- Left Sidebar -->
<div class="left-sidebar">
    <div class="sidebar-upload" id="uploadBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <span>Subir</span>
    </div>
    
    <div class="sidebar-item active" data-section="feed">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        </svg>
        <span>Inicio</span>
    </div>
    
    <div class="sidebar-item" data-section="shorts">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect>
        </svg>
        <span>Shorts</span>
    </div>
    
    <div class="sidebar-item" data-section="longs">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="10" rx="2" ry="2"></rect>
        </svg>
        <span>Longs</span>
    </div>
    
    <div class="sidebar-divider"></div>
    
    <div class="sidebar-item" data-section="friends">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span>Amigos</span>
    </div>
    
    <div class="sidebar-item" data-section="chat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span>Chat</span>
    </div>
    
    <div class="sidebar-divider"></div>
    
    <div class="sidebar-item" data-section="profile">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Perfil</span>
    </div>
    
    <div class="sidebar-item" data-section="settings">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m8.66-10.66l-4.24 4.24m-4.24 4.24L3.34 21.66M23 12h-6m-6 0H1m19.66 8.66l-4.24-4.24m-4.24-4.24L3.34 3.34"></path>
        </svg>
        <span>Ajustes</span>
    </div>

    <!-- Modal de subir video -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Subir Video</h2>
                <svg class="close-btn" id="closeUpload" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
            <div class="upload-area" id="uploadArea">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <p style="margin-top: 15px;">Haz clic para seleccionar un video</p>
                <p style="font-size: 12px; opacity: 0.6; margin-top: 5px;">⚠️ Máximo 50MB - Recomendado: videos cortos de 10-30 segundos</p>
                <input type="file" id="videoInput" accept="video/*" />
            </div>
            <input type="text" id="videoDescription" placeholder="Descripción del video..." style="width: 100%; padding: 12px; background: #252525; border: none; border-radius: 10px; color: #fff; margin-bottom: 15px;" />
            <input type="text" id="videoTitle" placeholder="Título del video..." style="width: 100%; padding: 12px; background: #252525; border: none; border-radius: 10px; color: #fff; margin-bottom: 15px;" />
            <button class="btn-primary" id="uploadVideoBtn" style="width: 100%;">Publicar Video</button>
        </div>
    </div>

    <!-- Modal de editar perfil -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Perfil</h2>
                <svg class="close-btn" id="closeEditProfile" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
            <div class="upload-area" id="avatarUploadArea">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <p style="margin-top: 15px;">Cambiar foto de perfil</p>
                <input type="file" id="avatarInput" accept="image/*" />
            </div>
            <input type="text" id="editName" placeholder="Nombre" style="width: 100%; padding: 12px; background: #252525; border: none; border-radius: 10px; color: #fff; margin: 10px 0;" />
            <button class="btn-primary" id="saveProfileBtn" style="width: 100%;">Guardar Cambios</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- PeerJS para videollamadas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>

    <script>
        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDm58-CYHGQWOHUvFgTEScKRZP5bfaReTA",
            authDomain: "yoquesewatch.firebaseapp.com",
            databaseURL: "https://yoquesewatch-default-rtdb.firebaseio.com",
            projectId: "yoquesewatch",
            storageBucket: "yoquesewatch.firebasestorage.app",
            messagingSenderId: "983249234884",
            appId: "1:983249234884:web:1d1878ada535d4cd1a5291"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let isLoginMode = true;
        let peer = null;
        let currentCall = null;
        let localStream = null;
        let currentChatUser = null;
        let currentViewingUserId = null;
        let googleProvider = null;
        let currentSearchTab = 'users';
        // Variables globales para comentarios
let currentVideoIdForComments = null;

// Abrir modal de comentarios
function openCommentsModal(videoId) {
    currentVideoIdForComments = videoId;
    document.getElementById('commentsModal').classList.add('active');
    loadComments(videoId);
}

// Cerrar modal de comentarios
document.getElementById('closeComments').addEventListener('click', () => {
    document.getElementById('commentsModal').classList.remove('active');
    currentVideoIdForComments = null;
});

// Cargar comentarios
async function loadComments(videoId) {
    const commentsList = document.getElementById('commentsList');
    commentsList.innerHTML = '<div class="loading">Cargando comentarios...</div>';
    
    const commentsRef = db.ref(`comments/${videoId}`);
    
    commentsRef.on('value', async (snapshot) => {
        commentsList.innerHTML = '';
        
        if (!snapshot.exists()) {
            commentsList.innerHTML = '<div class="no-comments">No hay comentarios aún<br>¡Sé el primero en comentar!</div>';
            return;
        }
        
        const comments = [];
        snapshot.forEach(child => {
            comments.push({ id: child.key, ...child.val() });
        });
        
        // Ordenar por fecha (más recientes primero)
        comments.sort((a, b) => b.timestamp - a.timestamp);
        
        // Mostrar comentarios
        for (const comment of comments) {
            const userSnapshot = await db.ref(`users/${comment.userId}`).once('value');
            const user = userSnapshot.val();
            
            const commentItem = document.createElement('div');
            commentItem.className = 'comment-item';
            commentItem.innerHTML = `
                <img class="comment-avatar" src="${user?.avatar || ''}" alt="Avatar" data-user-id="${comment.userId}" />
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-username" data-user-id="${comment.userId}">@${user?.username || 'Usuario'}</span>
                        <span class="comment-time">${getTimeAgo(comment.timestamp)}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                </div>
            `;
            
            // Hacer clickeable el avatar y username
            const avatar = commentItem.querySelector('.comment-avatar');
            const username = commentItem.querySelector('.comment-username');
            
            [avatar, username].forEach(element => {
                element.addEventListener('click', () => {
                    const userId = element.dataset.userId;
                    document.getElementById('commentsModal').classList.remove('active');
                    openUserProfile(userId);
                });
            });
            
            commentsList.appendChild(commentItem);
        }
    });
}

// Enviar comentario
document.getElementById('sendComment').addEventListener('click', async () => {
    const commentInput = document.getElementById('commentInput');
    const text = commentInput.value.trim();
    
    if (!text || !currentVideoIdForComments) return;
    
    try {
        // Agregar comentario
        await db.ref(`comments/${currentVideoIdForComments}`).push({
            userId: currentUser.uid,
            text: text,
            timestamp: Date.now()
        });
        
        // Incrementar contador de comentarios
        const videoSnapshot = await db.ref(`videos/${currentVideoIdForComments}`).once('value');
        const video = videoSnapshot.val();
        await db.ref(`videos/${currentVideoIdForComments}/comments`).set((video.comments || 0) + 1);
        
        // Enviar notificación al dueño del video
        if (video.userId !== currentUser.uid) {
            await db.ref(`notifications/${video.userId}`).push({
                type: 'comment',
                fromUserId: currentUser.uid,
                videoId: currentVideoIdForComments,
                timestamp: Date.now(),
                read: false
            });
        }
        
        commentInput.value = '';
    } catch (error) {
        console.error('Error al enviar comentario:', error);
        alert('Error al enviar comentario');
    }
});

// Enter para enviar comentario
document.getElementById('commentInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('sendComment').click();
    }
});

// Abrir búsqueda
document.getElementById('openSearchBtn').addEventListener('click', () => {
    document.getElementById('globalSearchBar').style.display = 'block';
    document.getElementById('globalSearch').focus();
});

// Cerrar búsqueda
document.getElementById('closeGlobalSearch').addEventListener('click', () => {
    document.getElementById('globalSearchBar').style.display = 'none';
    document.getElementById('globalSearch').value = '';
    document.getElementById('globalSearchResults').innerHTML = '';
});

// Cambiar tabs de búsqueda
document.querySelectorAll('.search-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentSearchTab = tab.dataset.tab;
        document.getElementById('globalSearch').value = '';
        document.getElementById('globalSearchResults').innerHTML = '';
        document.getElementById('globalSearch').placeholder = currentSearchTab === 'users' ? 'Buscar usuarios...' : 'Buscar videos...';
    });
});

// Búsqueda en tiempo real
document.getElementById('globalSearch').addEventListener('input', async (e) => {
    const query = e.target.value.toLowerCase().trim();
    const searchResults = document.getElementById('globalSearchResults');
    
    if (!query) {
        searchResults.innerHTML = '';
        return;
    }

    if (currentSearchTab === 'users') {
        // Buscar usuarios
        const usersSnapshot = await db.ref('users').once('value');
        searchResults.innerHTML = '';
        
        let found = false;
        usersSnapshot.forEach(child => {
            if (child.key !== currentUser.uid) {
                const user = child.val();
                const username = (user.username || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                
                if (username.includes(query) || email.includes(query)) {
                    found = true;
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <img class="avatar" src="${user.avatar || ''}" alt="Avatar" />
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-username">@${user.username}</div>
                        </div>
                    `;
                    
                    userItem.addEventListener('click', () => {
                        openUserProfile(child.key);
                        document.getElementById('globalSearchBar').style.display = 'none';
                        document.getElementById('globalSearch').value = '';
                        searchResults.innerHTML = '';
                    });
                    
                    searchResults.appendChild(userItem);
                }
            }
        });
        
        if (!found) {
            searchResults.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No se encontraron usuarios</div>';
        }
    } else {
        // Buscar videos
        const videosSnapshot = await db.ref('videos').once('value');
        searchResults.innerHTML = '';
        
        let found = false;
        videosSnapshot.forEach(child => {
            const video = child.val();
            const videoTitle = (video.title || video.description || '').toLowerCase();
            const videoDesc = (video.description || '').toLowerCase();
            
            if (videoTitle.includes(query) || videoDesc.includes(query)) {
                found = true;
                
                // Obtener info del usuario
                db.ref(`users/${video.userId}`).once('value').then(userSnap => {
                    const user = userSnap.val();
                    
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-result-item';
                    videoItem.innerHTML = `
                        <video class="video-result-thumbnail" src="${video.videoUrl}" muted></video>
                        <div class="video-result-info">
                            <div class="video-result-title">${video.title || video.description || 'Video sin título'}</div>
                            <div class="video-result-username">@${user?.username || 'Usuario'}</div>
                            <div class="video-result-stats">${video.likes || 0} likes • ${video.views || 0} vistas</div>
                        </div>
                    `;
                    
                    videoItem.addEventListener('click', () => {
                        // Ir al video en el feed
                        document.getElementById('globalSearchBar').style.display = 'none';
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        document.querySelectorAll('.nav-item')[0].classList.add('active');
                        document.getElementById('videoFeed').style.display = 'block';
                        document.getElementById('profileSection').classList.remove('active');
                        document.getElementById('friendsSection').classList.remove('active');
                        document.getElementById('chatSection').classList.remove('active');
                        document.getElementById('settingsSection').classList.remove('active');
                        
                        // Scroll al video específico (esto requiere que tengas IDs en los videos)
                        loadVideos();
                    });
                    
                    searchResults.appendChild(videoItem);
                });
            }
        });
        
        if (!found) {
            setTimeout(() => {
                if (searchResults.children.length === 0) {
                    searchResults.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No se encontraron videos</div>';
                }
            }, 500);
        }
    }
});

// Sistema de notificaciones
async function loadNotifications() {
    if (!currentUser) return;
    
    const notificationsRef = db.ref(`notifications/${currentUser.uid}`);
    
    notificationsRef.on('value', async (snapshot) => {
        const notificationsList = document.getElementById('notificationsList');
        const badge = document.getElementById('notificationBadge');
        
        if (!snapshot.exists()) {
            notificationsList.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No hay notificaciones</div>';
            badge.style.display = 'none';
            return;
        }
        
        notificationsList.innerHTML = '';
        let unreadCount = 0;
        const notifications = [];
        
        snapshot.forEach(child => {
            const notif = { id: child.key, ...child.val() };
            notifications.push(notif);
            if (!notif.read) unreadCount++;
        });
        
        // Ordenar por fecha (más recientes primero)
        notifications.sort((a, b) => b.timestamp - a.timestamp);
        
        // Mostrar notificaciones
        for (const notif of notifications) {
            const userSnapshot = await db.ref(`users/${notif.fromUserId}`).once('value');
            const user = userSnapshot.val();
            
            const notifItem = document.createElement('div');
            notifItem.className = `notification-item ${!notif.read ? 'unread' : ''}`;
            
            let notifText = '';
            if (notif.type === 'follow') {
                notifText = `<strong>${user?.username || 'Usuario'}</strong> comenzó a seguirte`;
            } else if (notif.type === 'like') {
                notifText = `<strong>${user?.username || 'Usuario'}</strong> le dio like a tu video`;
            } else if (notif.type === 'comment') {
                notifText = `<strong>${user?.username || 'Usuario'}</strong> comentó tu video`;
            }
            
            notifItem.innerHTML = `
                <img class="notification-avatar" src="${user?.avatar || ''}" alt="Avatar" />
                <div class="notification-content">
                    <div class="notification-text">${notifText}</div>
                    <div class="notification-time">${getTimeAgo(notif.timestamp)}</div>
                </div>
            `;
            
            notifItem.addEventListener('click', async () => {
                // Marcar como leída
                await db.ref(`notifications/${currentUser.uid}/${notif.id}/read`).set(true);
                
                // Ir al perfil del usuario o al video
                if (notif.type === 'follow') {
                    openUserProfile(notif.fromUserId);
                }
                
                document.getElementById('notificationsPanel').style.display = 'none';
            });
            
            notificationsList.appendChild(notifItem);
        }
        
        // Actualizar badge
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    });
}

// Función para calcular tiempo transcurrido
function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Ahora';
    if (minutes < 60) return `Hace ${minutes}m`;
    if (hours < 24) return `Hace ${hours}h`;
    return `Hace ${days}d`;
}

// Abrir/cerrar panel de notificaciones
document.getElementById('notificationsBtn').addEventListener('click', () => {
    const panel = document.getElementById('notificationsPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('closeNotifications').addEventListener('click', () => {
    document.getElementById('notificationsPanel').style.display = 'none';
});

// Enviar notificación cuando alguien te sigue
async function sendFollowNotification(toUserId) {
    await db.ref(`notifications/${toUserId}`).push({
        type: 'follow',
        fromUserId: currentUser.uid,
        timestamp: Date.now(),
        read: false
    });
}

// Enviar notificación cuando alguien da like
async function sendLikeNotification(toUserId, videoId) {
    await db.ref(`notifications/${toUserId}`).push({
        type: 'like',
        fromUserId: currentUser.uid,
        videoId: videoId,
        timestamp: Date.now(),
        read: false
    });
}

        // Traducciones
const translations = {
    es: {
        // Autenticación
        authTitle: 'Iniciar Sesión',
        authTitleRegister: 'Registrarse',
        authUsername: 'Nombre de usuario',
        authEmail: 'Email',
        authPassword: 'Contraseña',
        authSubmit: 'Entrar',
        authSubmitRegister: 'Crear Cuenta',
        authToggle: '¿No tienes cuenta? Regístrate',
        authToggleLogin: '¿Ya tienes cuenta? Inicia sesión',
        authGoogle: 'Continuar con Google',
        
        // Navegación
        navHome: 'Inicio',
        navFriends: 'Amigos',
        navChat: 'Chat',
        navProfile: 'Perfil',
        navSettings: 'Ajustes',
        
        // Perfil
        profileFollowing: 'Siguiendo',
        profileFollowers: 'Seguidores',
        profileLikes: 'Me gusta',
        profileEdit: 'Editar Perfil',
        
        // Subir video
        uploadTitle: 'Subir Video',
        uploadText: 'Haz clic para seleccionar un video',
        uploadWarning: '⚠️ Máximo 50MB - Recomendado: videos cortos de 10-30 segundos',
        uploadDescription: 'Descripción del video...',
        uploadButton: 'Publicar Video',
        uploadUploading: 'Subiendo... Esto puede tardar',
        uploadSuccess: '¡Video subido exitosamente!',
        uploadError: 'Error al subir el video',
        uploadSelectVideo: 'Por favor selecciona un video',
        uploadTooBig: 'El video es demasiado grande. Por favor, sube videos de máximo 50MB. Recomendación: videos de 10-30 segundos.',
        
        // Editar perfil
        editProfileTitle: 'Editar Perfil',
        editProfileAvatar: 'Cambiar foto de perfil',
        editProfileName: 'Nombre',
        editProfileSave: 'Guardar Cambios',
        editProfileUpdated: 'Perfil actualizado',
        editProfileImageSelected: 'Imagen seleccionada',
        
        // Amigos
        friendsSearch: 'Buscar usuarios...',
        friendsFollow: 'Seguir',
        friendsFollowing: 'Siguiendo',
        friendsNoResults: 'No se encontraron usuarios',
        
        // Chat
        chatMessage: 'Escribe un mensaje...',
        chatLoading: 'Cargando chats...',
        chatClick: 'Click para chatear',
        
        // Videollamada
        callConnecting: 'Conectando...',
        callConnected: 'Conectado',
        callUnavailable: 'El usuario no está disponible para videollamadas',
        callError: 'No se pudo acceder a la cámara y micrófono',
        
        // Ajustes
        settingsTitle: 'Ajustes',
        settingsAccount: 'Información de cuenta',
        settingsAccountDesc: 'Ver detalles de tu cuenta',
        settingsLogout: 'Cerrar sesión',
        settingsLogoutDesc: 'Salir de tu cuenta',
        settingsDelete: 'Eliminar cuenta',
        settingsDeleteDesc: 'Borrar permanentemente tu cuenta',
        
        // Modales de confirmación
        confirmLogoutTitle: '¿Cerrar sesión?',
        confirmLogoutMessage: '¿Estás seguro de que quieres salir de tu cuenta?',
        confirmDeleteTitle: '⚠️ ¿Eliminar cuenta?',
        confirmDeleteMessage: 'Esta acción es PERMANENTE. Se eliminarán todos tus videos, mensajes y datos. No se puede deshacer.',
        confirmCancel: 'Cancelar',
        confirmAccept: 'Confirmar',
        
        // Mensajes del sistema
        logoutSuccess: 'Sesión cerrada correctamente',
        deleteSuccess: 'Cuenta eliminada correctamente',
        deleteRelogin: 'Por seguridad, necesitas volver a iniciar sesión antes de eliminar tu cuenta.',
        errorAuth: 'Error: ',
        errorGeneric: 'Error: ',
        
        // Perfil de usuario
        userFollow: 'Seguir',
        userFollowing: 'Siguiendo',
        userChat: 'Chatear',
        userError: 'Error: No se pudo identificar al usuario',
        
        // Video
        videoViews: 'views',
        videoLoading: 'Cargando videos...',
        videoSelected: 'Seleccionado: '
    },
    
    en: {
        // Authentication
        authTitle: 'Sign In',
        authTitleRegister: 'Sign Up',
        authUsername: 'Username',
        authEmail: 'Email',
        authPassword: 'Password',
        authSubmit: 'Enter',
        authSubmitRegister: 'Create Account',
        authToggle: "Don't have an account? Sign up",
        authToggleLogin: 'Already have an account? Sign in',
        authGoogle: 'Continue with Google',
        
        // Navigation
        navHome: 'Home',
        navFriends: 'Friends',
        navChat: 'Chat',
        navProfile: 'Profile',
        navSettings: 'Settings',
        
        // Profile
        profileFollowing: 'Following',
        profileFollowers: 'Followers',
        profileLikes: 'Likes',
        profileEdit: 'Edit Profile',
        
        // Upload video
        uploadTitle: 'Upload Video',
        uploadText: 'Click to select a video',
        uploadWarning: '⚠️ Maximum 50MB - Recommended: short videos of 10-30 seconds',
        uploadDescription: 'Video description...',
        uploadButton: 'Publish Video',
        uploadUploading: 'Uploading... This may take a while',
        uploadSuccess: 'Video uploaded successfully!',
        uploadError: 'Error uploading video',
        uploadSelectVideo: 'Please select a video',
        uploadTooBig: 'The video is too large. Please upload videos up to 50MB. Recommendation: 10-30 second videos.',
        
        // Edit profile
        editProfileTitle: 'Edit Profile',
        editProfileAvatar: 'Change profile picture',
        editProfileName: 'Name',
        editProfileSave: 'Save Changes',
        editProfileUpdated: 'Profile updated',
        editProfileImageSelected: 'Image selected',
        
        // Friends
        friendsSearch: 'Search users...',
        friendsFollow: 'Follow',
        friendsFollowing: 'Following',
        friendsNoResults: 'No users found',
        
        // Chat
        chatMessage: 'Write a message...',
        chatLoading: 'Loading chats...',
        chatClick: 'Click to chat',
        
        // Video call
        callConnecting: 'Connecting...',
        callConnected: 'Connected',
        callUnavailable: 'User is not available for video calls',
        callError: 'Could not access camera and microphone',
        
        // Settings
        settingsTitle: 'Settings',
        settingsAccount: 'Account information',
        settingsAccountDesc: 'View your account details',
        settingsLogout: 'Sign out',
        settingsLogoutDesc: 'Log out of your account',
        settingsDelete: 'Delete account',
        settingsDeleteDesc: 'Permanently delete your account',
        
        // Confirmation modals
        confirmLogoutTitle: 'Sign out?',
        confirmLogoutMessage: 'Are you sure you want to log out of your account?',
        confirmDeleteTitle: '⚠️ Delete account?',
        confirmDeleteMessage: 'This action is PERMANENT. All your videos, messages and data will be deleted. This cannot be undone.',
        confirmCancel: 'Cancel',
        confirmAccept: 'Confirm',
        
        // System messages
        logoutSuccess: 'Signed out successfully',
        deleteSuccess: 'Account deleted successfully',
        deleteRelogin: 'For security, you need to sign in again before deleting your account.',
        errorAuth: 'Error: ',
        errorGeneric: 'Error: ',
        
        // User profile
        userFollow: 'Follow',
        userFollowing: 'Following',
        userChat: 'Chat',
        userError: 'Error: Could not identify user',
        
        // Video
        videoViews: 'views',
        videoLoading: 'Loading videos...',
        videoSelected: 'Selected: '
    },
    
    fr: {
        // Authentification
        authTitle: 'Se connecter',
        authTitleRegister: "S'inscrire",
        authUsername: "Nom d'utilisateur",
        authEmail: 'Email',
        authPassword: 'Mot de passe',
        authSubmit: 'Entrer',
        authSubmitRegister: 'Créer un compte',
        authToggle: "Pas de compte? Inscrivez-vous",
        authToggleLogin: 'Vous avez déjà un compte? Connectez-vous',
        authGoogle: 'Continuer avec Google',
        
        // Navigation
        navHome: 'Accueil',
        navFriends: 'Amis',
        navChat: 'Chat',
        navProfile: 'Profil',
        navSettings: 'Paramètres',
        
        // Profil
        profileFollowing: 'Abonnements',
        profileFollowers: 'Abonnés',
        profileLikes: "J'aime",
        profileEdit: 'Modifier le profil',
        
        // Télécharger vidéo
        uploadTitle: 'Télécharger une vidéo',
        uploadText: 'Cliquez pour sélectionner une vidéo',
        uploadWarning: '⚠️ Maximum 50 Mo - Recommandé: vidéos courtes de 10-30 secondes',
        uploadDescription: 'Description de la vidéo...',
        uploadButton: 'Publier la vidéo',
        uploadUploading: 'Téléchargement... Cela peut prendre du temps',
        uploadSuccess: 'Vidéo téléchargée avec succès!',
        uploadError: 'Erreur lors du téléchargement',
        uploadSelectVideo: 'Veuillez sélectionner une vidéo',
        uploadTooBig: 'La vidéo est trop volumineuse. Veuillez télécharger des vidéos de 50 Mo maximum. Recommandation: vidéos de 10-30 secondes.',
        
        // Modifier profil
        editProfileTitle: 'Modifier le profil',
        editProfileAvatar: 'Changer la photo de profil',
        editProfileName: 'Nom',
        editProfileSave: 'Enregistrer les modifications',
        editProfileUpdated: 'Profil mis à jour',
        editProfileImageSelected: 'Image sélectionnée',
        
        // Amis
        friendsSearch: 'Rechercher des utilisateurs...',
        friendsFollow: 'Suivre',
        friendsFollowing: 'Suivi',
        friendsNoResults: 'Aucun utilisateur trouvé',
        
        // Chat
        chatMessage: 'Écrivez un message...',
        chatLoading: 'Chargement des chats...',
        chatClick: 'Cliquer pour chatter',
        
        // Appel vidéo
        callConnecting: 'Connexion...',
        callConnected: 'Connecté',
        callUnavailable: "L'utilisateur n'est pas disponible pour les appels vidéo",
        callError: 'Impossible d\'accéder à la caméra et au microphone',
        
        // Paramètres
        settingsTitle: 'Paramètres',
        settingsAccount: 'Informations du compte',
        settingsAccountDesc: 'Voir les détails de votre compte',
        settingsLogout: 'Se déconnecter',
        settingsLogoutDesc: 'Quitter votre compte',
        settingsDelete: 'Supprimer le compte',
        settingsDeleteDesc: 'Supprimer définitivement votre compte',
        
        // Modaux de confirmation
        confirmLogoutTitle: 'Se déconnecter?',
        confirmLogoutMessage: 'Êtes-vous sûr de vouloir quitter votre compte?',
        confirmDeleteTitle: '⚠️ Supprimer le compte?',
        confirmDeleteMessage: 'Cette action est PERMANENTE. Toutes vos vidéos, messages et données seront supprimés. Cela ne peut pas être annulé.',
        confirmCancel: 'Annuler',
        confirmAccept: 'Confirmer',
        
        // Messages système
        logoutSuccess: 'Déconnexion réussie',
        deleteSuccess: 'Compte supprimé avec succès',
        deleteRelogin: 'Pour des raisons de sécurité, vous devez vous reconnecter avant de supprimer votre compte.',
        errorAuth: 'Erreur: ',
        errorGeneric: 'Erreur: ',
        
        // Profil utilisateur
        userFollow: 'Suivre',
        userFollowing: 'Suivi',
        userChat: 'Chatter',
        userError: "Erreur: Impossible d'identifier l'utilisateur",
        
        // Vidéo
        videoViews: 'vues',
        videoLoading: 'Chargement des vidéos...',
        videoSelected: 'Sélectionné: '
    },
    
    it: {
        // Autenticazione
        authTitle: 'Accedi',
        authTitleRegister: 'Registrati',
        authUsername: 'Nome utente',
        authEmail: 'Email',
        authPassword: 'Password',
        authSubmit: 'Entra',
        authSubmitRegister: 'Crea account',
        authToggle: 'Non hai un account? Registrati',
        authToggleLogin: 'Hai già un account? Accedi',
        authGoogle: 'Continua con Google',
        
        // Navigazione
        navHome: 'Home',
        navFriends: 'Amici',
        navChat: 'Chat',
        navProfile: 'Profilo',
        navSettings: 'Impostazioni',
        
        // Profilo
        profileFollowing: 'Seguiti',
        profileFollowers: 'Follower',
        profileLikes: 'Mi piace',
        profileEdit: 'Modifica profilo',
        
        // Carica video
        uploadTitle: 'Carica video',
        uploadText: 'Clicca per selezionare un video',
        uploadWarning: '⚠️ Massimo 50MB - Consigliato: video brevi di 10-30 secondi',
        uploadDescription: 'Descrizione del video...',
        uploadButton: 'Pubblica video',
        uploadUploading: 'Caricamento... Potrebbe richiedere del tempo',
        uploadSuccess: 'Video caricato con successo!',
        uploadError: 'Errore nel caricamento del video',
        uploadSelectVideo: 'Seleziona un video',
        uploadTooBig: 'Il video è troppo grande. Carica video fino a 50MB. Raccomandazione: video di 10-30 secondi.',
        
        // Modifica profilo
        editProfileTitle: 'Modifica profilo',
        editProfileAvatar: 'Cambia foto profilo',
        editProfileName: 'Nome',
        editProfileSave: 'Salva modifiche',
        editProfileUpdated: 'Profilo aggiornato',
        editProfileImageSelected: 'Immagine selezionata',
        
        // Amici
        friendsSearch: 'Cerca utenti...',
        friendsFollow: 'Segui',
        friendsFollowing: 'Seguito',
        friendsNoResults: 'Nessun utente trovato',
        
        // Chat
        chatMessage: 'Scrivi un messaggio...',
        chatLoading: 'Caricamento chat...',
        chatClick: 'Clicca per chattare',
        
        // Videochiamata
        callConnecting: 'Connessione...',
        callConnected: 'Connesso',
        callUnavailable: "L'utente non è disponibile per videochiamate",
        callError: 'Impossibile accedere a fotocamera e microfono',
        
        // Impostazioni
        settingsTitle: 'Impostazioni',
        settingsAccount: 'Informazioni account',
        settingsAccountDesc: 'Visualizza i dettagli del tuo account',
        settingsLogout: 'Disconnetti',
        settingsLogoutDesc: 'Esci dal tuo account',
        settingsDelete: 'Elimina account',
        settingsDeleteDesc: 'Elimina permanentemente il tuo account',
        
        // Modali di conferma
        confirmLogoutTitle: 'Disconnettersi?',
        confirmLogoutMessage: 'Sei sicuro di voler uscire dal tuo account?',
        confirmDeleteTitle: '⚠️ Eliminare account?',
        confirmDeleteMessage: 'Questa azione è PERMANENTE. Tutti i tuoi video, messaggi e dati verranno eliminati. Non può essere annullata.',
        confirmCancel: 'Annulla',
        confirmAccept: 'Conferma',
        
        // Messaggi di sistema
        logoutSuccess: 'Disconnessione riuscita',
        deleteSuccess: 'Account eliminato con successo',
        deleteRelogin: 'Per sicurezza, devi accedere nuovamente prima di eliminare il tuo account.',
        errorAuth: 'Errore: ',
        errorGeneric: 'Errore: ',
        
        // Profilo utente
        userFollow: 'Segui',
        userFollowing: 'Seguito',
        userChat: 'Chatta',
        userError: "Errore: Impossibile identificare l'utente",
        
        // Video
        videoViews: 'visualizzazioni',
        videoLoading: 'Caricamento video...',
        videoSelected: 'Selezionato: '
    }
};

// Detectar idioma del navegador
let currentLanguage = 'es'; // idioma por defecto

function detectLanguage() {
    const browserLang = navigator.language || navigator.userLanguage;
    const lang = browserLang.split('-')[0]; // obtener solo 'es' de 'es-ES'
    
    // Verificar si el idioma está disponible
    if (translations[lang]) {
        currentLanguage = lang;
    } else {
        currentLanguage = 'en'; // inglés como fallback
    }
    
    console.log('Idioma detectado:', currentLanguage);
}

// Función para obtener traducción
function t(key) {
    return translations[currentLanguage][key] || translations['en'][key] || key;
}

// Función para actualizar todos los textos de la interfaz
function updateLanguage() {
    // Autenticación
    document.getElementById('authTitle').textContent = isLoginMode ? t('authTitle') : t('authTitleRegister');
    document.getElementById('authUsername').placeholder = t('authUsername');
    document.getElementById('authEmail').placeholder = t('authEmail');
    document.getElementById('authPassword').placeholder = t('authPassword');
    document.getElementById('authSubmit').textContent = isLoginMode ? t('authSubmit') : t('authSubmitRegister');
    document.getElementById('authToggle').textContent = isLoginMode ? t('authToggle') : t('authToggleLogin');
    document.getElementById('googleLogin').childNodes[2].textContent = ' ' + t('authGoogle');
    
    // Navegación inferior
    document.querySelectorAll('.nav-item')[0].querySelector('span').textContent = t('navHome');
    document.querySelectorAll('.nav-item')[1].querySelector('span').textContent = t('navFriends');
    document.querySelectorAll('.nav-item')[2].querySelector('span').textContent = t('navChat');
    document.querySelectorAll('.nav-item')[3].querySelector('span').textContent = t('navProfile');
    document.querySelectorAll('.nav-item')[4].querySelector('span').textContent = t('navSettings');
    
    // Modales
    document.querySelector('#uploadModal .modal-header h2').textContent = t('uploadTitle');
    document.querySelector('#editProfileModal .modal-header h2').textContent = t('editProfileTitle');
    
    // Inputs de modales
    document.getElementById('videoDescription').placeholder = t('uploadDescription');
    document.getElementById('uploadVideoBtn').textContent = t('uploadButton');
    document.getElementById('editName').placeholder = t('editProfileName');
    document.getElementById('saveProfileBtn').textContent = t('editProfileSave');
    
    // Búsqueda de amigos
    document.getElementById('friendsSearch').placeholder = t('friendsSearch');
    
    // Chat
    document.getElementById('messageInput').placeholder = t('chatMessage');
    
    // Ajustes
    document.querySelector('.settings-header h2').textContent = t('settingsTitle');
    document.querySelectorAll('.settings-item')[0].querySelector('.settings-title').textContent = t('settingsAccount');
    document.querySelectorAll('.settings-item')[0].querySelector('.settings-description').textContent = t('settingsAccountDesc');
    document.querySelectorAll('.settings-item')[1].querySelector('.settings-title').textContent = t('settingsLogout');
    document.querySelectorAll('.settings-item')[1].querySelector('.settings-description').textContent = t('settingsLogoutDesc');
    document.querySelectorAll('.settings-item')[2].querySelector('.settings-title').textContent = t('settingsDelete');
    document.querySelectorAll('.settings-item')[2].querySelector('.settings-description').textContent = t('settingsDeleteDesc');
    
    // Perfil
    const statLabels = document.querySelectorAll('.stat-label');
    if (statLabels.length >= 3) {
        statLabels[0].textContent = t('profileFollowing');
        statLabels[1].textContent = t('profileFollowers');
        statLabels[2].textContent = t('profileLikes');
    }
    
    document.getElementById('editProfileBtn').textContent = t('profileEdit');
    
    // Botones de confirmación
    document.getElementById('confirmCancel').textContent = t('confirmCancel');
    document.getElementById('confirmAccept').textContent = t('confirmAccept');
}

// Inicializar idioma al cargar
detectLanguage();
        
        // Inicializar Google provider después de que Firebase esté listo
        try {
            googleProvider = new firebase.auth.GoogleAuthProvider();
            googleProvider.addScope('profile');
            googleProvider.addScope('email');
        } catch (error) {
            console.error('Error al inicializar Google provider:', error);
        }

        // ✅ Agregar esto DESPUÉS de inicializar googleProvider
document.getElementById('googleLogin').addEventListener('click', async () => {
    try {
        const result = await auth.signInWithPopup(googleProvider);
        // El auth.onAuthStateChanged se encargará del resto automáticamente
        console.log("Login con Google exitoso:", result.user.uid);
    } catch (error) {
        console.error("Error con Google:", error);
        alert("No se pudo iniciar sesión con Google: " + error.message);
    }
});

        // Autenticación
        document.getElementById('authToggle').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            updateLanguage();
            document.getElementById('authTitle').textContent = isLoginMode ? 'Iniciar Sesión' : 'Registrarse';
            document.getElementById('authSubmit').textContent = isLoginMode ? 'Entrar' : 'Crear Cuenta';
            document.getElementById('authToggle').textContent = isLoginMode ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Inicia sesión';
            document.getElementById('authUsername').style.display = isLoginMode ? 'none' : 'block';
        });

        document.getElementById('authSubmit').addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const username = document.getElementById('authUsername').value;

            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.ref(`users/${userCredential.user.uid}`).set({
                        username: username,
                        email: email,
                        avatar: '',
                        followers: 0,
                        following: 0,
                        likes: 0,
                        createdAt: Date.now()
                    });
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        
        const userSnapshot = await db.ref(`users/${user.uid}`).once('value');
        
        if (!userSnapshot.exists()) {
            await db.ref(`users/${user.uid}`).set({
                username: user.displayName || user.email.split('@')[0],
                email: user.email,
                avatar: user.photoURL || '',
                followers: 0,
                following: 0,
                likes: 0,
                createdAt: Date.now()
            });
        }
        
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('appContainer').classList.add('active');
        
        // ✅ ACTUALIZAR IDIOMA AQUÍ
        updateLanguage();
        initializePeer();
        loadVideos();
        loadProfile();
        loadFriends();
        loadNotifications(); // ✅ AGREGAR ESTO
    } else {
        currentUser = null;
        document.getElementById('authScreen').style.display = 'flex';
        document.getElementById('appContainer').classList.remove('active');
        
        // ✅ ACTUALIZAR IDIOMA TAMBIÉN EN LOGIN
        updateLanguage();
    }
});

        // Navegación
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                const section = item.dataset.section;
                document.getElementById('videoFeed').style.display = section === 'feed' ? 'block' : 'none';
                document.getElementById('profileSection').classList.toggle('active', section === 'profile');
                document.getElementById('friendsSection').classList.toggle('active', section === 'friends');
                document.getElementById('chatSection').classList.toggle('active', section === 'chat');
                document.getElementById('settingsSection').classList.toggle('active', section === 'settings');

                if (section === 'profile') loadProfile();
                if (section === 'friends') loadFriends();
                if (section === 'chat') loadChats();
            });
        });

        // Subir video
        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('uploadModal').classList.add('active');
        });

        document.getElementById('closeUpload').addEventListener('click', () => {
            document.getElementById('uploadModal').classList.remove('active');
        });

        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('videoInput').click();
        });

        let selectedVideo = null;
        document.getElementById('videoInput').addEventListener('change', (e) => {
            selectedVideo = e.target.files[0];
            if (selectedVideo) {
                document.querySelector('.upload-area p').textContent = 'Seleccionado: ' + selectedVideo.name;
            }
        });

        // Función para convertir archivo a Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Función para comprimir video (dividir en chunks)
        async function compressAndUploadVideo(file, description) {
            const videoBase64 = await fileToBase64(file);
            
            // Verificar tamaño (10MB en base64 son aproximadamente 7.5MB de archivo)
            const sizeInBytes = videoBase64.length;
            const sizeInMB = sizeInBytes / 1024 / 1024;
            
            if (sizeInMB > 10) {
                throw new Error('El video es demasiado grande. Por favor, sube un video menor a 10MB o más corto (máximo 30 segundos recomendados).');
            }

            // Si el video es pequeño, subir normalmente
            if (sizeInMB < 5) {
                return await db.ref('videos').push({
                    userId: currentUser.uid,
                    videoUrl: videoBase64,
                    description: description,
                    likes: 0,
                    comments: 0,
                    shares: 0,
                    views: 0,
                    timestamp: Date.now()
                });
            }
            
            // Si el video es grande (5-10MB), dividir en chunks
            const chunkSize = 1024 * 1024 * 4; // 4MB por chunk
            const chunks = [];
            
            for (let i = 0; i < videoBase64.length; i += chunkSize) {
                chunks.push(videoBase64.slice(i, i + chunkSize));
            }
            
            const videoId = db.ref('videos').push().key;
            
            // Guardar chunks
            for (let i = 0; i < chunks.length; i++) {
                await db.ref('videoChunks/' + videoId + '/chunk' + i).set(chunks[i]);
            }
            
            // Guardar metadata del video
            await db.ref('videos/' + videoId).set({
                userId: currentUser.uid,
                videoUrl: 'CHUNKED', // Indicador de que está dividido en chunks
                chunked: true,
                chunkCount: chunks.length,
                description: description,
                likes: 0,
                comments: 0,
                shares: 0,
                views: 0,
                timestamp: Date.now()
            });
            
            return { key: videoId };
        }

        document.getElementById('uploadVideoBtn').addEventListener('click', async () => {
    if (!selectedVideo) {
        alert('Por favor selecciona un video');
        return;
    }

    const fileSizeInMB = selectedVideo.size / 1024 / 1024;
    if (fileSizeInMB > 50) {
        alert('El video es demasiado grande...');
        return;
    }

    const title = document.getElementById('videoTitle').value || 'Sin título';
    const description = document.getElementById('videoDescription').value;
    
    try {
        document.getElementById('uploadVideoBtn').textContent = 'Subiendo...';
        document.getElementById('uploadVideoBtn').disabled = true;
        
        const videoBase64 = await fileToBase64(selectedVideo);
        
        await db.ref('videos').push({
    userId: currentUser.uid,
    videoUrl: videoBase64,
    title: title,
    description: description,
    type: selectedVideoType, // ✅ AGREGAR ESTA LÍNEA
    likes: 0,
    comments: 0,
    shares: 0,
    views: 0,
    timestamp: Date.now()
});

        document.getElementById('uploadModal').classList.remove('active');
        document.getElementById('videoTitle').value = '';
        document.getElementById('videoDescription').value = '';
        document.getElementById('uploadVideoBtn').textContent = 'Publicar Video';
        document.getElementById('uploadVideoBtn').disabled = false;
        selectedVideo = null;
        loadVideos();
        alert('¡Video subido exitosamente!');
    } catch (error) {
        alert('Error: ' + error.message);
        document.getElementById('uploadVideoBtn').textContent = 'Publicar Video';
        document.getElementById('uploadVideoBtn').disabled = false;
    }
});

        // Cargar videos
        async function loadVideos() {
    const videosRef = db.ref('videos').orderByChild('timestamp');
    const snapshot = await videosRef.once('value');
    const videos = [];
    
    snapshot.forEach(child => {
        videos.push({ id: child.key, ...child.val() });
    });

    videos.reverse();

    const videoFeed = document.getElementById('videoFeed');
    videoFeed.innerHTML = '';

    for (const video of videos) {
        const userSnapshot = await db.ref(`users/${video.userId}`).once('value');
        const user = userSnapshot.val();

        const videoContainer = document.createElement('div');
        videoContainer.className = 'video-container';
        videoContainer.dataset.videoId = video.id; // ✅ Importante para poder navegar a este video
        
        videoContainer.innerHTML = `
            <video class="video-player" src="${video.videoUrl}" loop></video>
            <div class="video-controls">
                <div class="play-pause-btn">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                </div>
            </div>
            <div class="volume-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>
            </div>
            <div class="video-overlay">
                <div class="video-info">
                    ${video.title ? `<div class="video-title">${video.title}</div>` : ''}
                    <div class="video-username">@${user?.username || 'Usuario'}</div>
                    <div class="video-description">${video.description || ''}</div>
                </div>
            </div>
            <div class="video-actions">
                <div class="action-btn" data-action="like" data-video="${video.id}">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    <span>${video.likes || 0}</span>
                </div>
                <div class="action-btn" data-action="comment" data-video="${video.id}">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>${video.comments || 0}</span>
                </div>
                <div class="action-btn" data-action="share">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    <span>${video.shares || 0}</span>
                </div>
                <img class="avatar" src="${user?.avatar || ''}" alt="Avatar" data-user-id="${video.userId}" />
            </div>
        `;

        videoFeed.appendChild(videoContainer);

        const videoPlayer = videoContainer.querySelector('.video-player');
        const playPauseBtn = videoContainer.querySelector('.play-pause-btn');
        const volumeBtn = videoContainer.querySelector('.volume-btn');

        // Auto-play cuando sea visible
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            });
        }, { threshold: 0.5 });

        observer.observe(videoContainer);

        // Control de reproducción
        playPauseBtn.addEventListener('click', () => {
            if (videoPlayer.paused) {
                videoPlayer.play();
                playPauseBtn.innerHTML = `<svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>`;
            } else {
                videoPlayer.pause();
                playPauseBtn.innerHTML = `<svg width="30" height="30" viewBox="0 0 24 24" fill="white">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>`;
            }
        });

        // Control de volumen
        volumeBtn.addEventListener('click', () => {
            videoPlayer.muted = !videoPlayer.muted;
            volumeBtn.innerHTML = videoPlayer.muted ? 
                `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <line x1="23" y1="9" x2="17" y2="15"></line>
                    <line x1="17" y1="9" x2="23" y2="15"></line>
                </svg>` :
                `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>`;
        });

        // Like
        const likeBtn = videoContainer.querySelector('[data-action="like"]');
        likeBtn.addEventListener('click', async () => {
            if (!likeBtn.classList.contains('liked')) {
                likeBtn.classList.add('liked');
                await db.ref(`videos/${video.id}/likes`).set((video.likes || 0) + 1);
                likeBtn.querySelector('span').textContent = (video.likes || 0) + 1;
                
                // Enviar notificación
                if (video.userId !== currentUser.uid) {
                    await sendLikeNotification(video.userId, video.id);
                }
            }
        });

        // ✅ Comentarios
        const commentBtn = videoContainer.querySelector('[data-action="comment"]');
        commentBtn.addEventListener('click', () => {
            openCommentsModal(video.id);
        });

        // ✅ Click en avatar para ver perfil
        const avatar = videoContainer.querySelector('.avatar');
        avatar.addEventListener('click', () => {
            const userId = avatar.dataset.userId;
            openUserProfile(userId);
        });

        // Click en username para ver perfil
        const username = videoContainer.querySelector('.video-username');
        username.addEventListener('click', () => {
            openUserProfile(video.userId);
        });
    }
}

        // Cargar perfil
        async function loadProfile() {
    const userSnapshot = await db.ref(`users/${currentUser.uid}`).once('value');
    const userData = userSnapshot.val();

    // ✅ SINCRONIZAR CONTADORES AL CARGAR
    const realFollowers = await getFollowersCount(currentUser.uid);
    const realFollowing = await getFollowingCount(currentUser.uid);
    
    // Si hay diferencias, actualizar
    if (realFollowers !== userData.followers || realFollowing !== userData.following) {
        await db.ref(`users/${currentUser.uid}`).update({
            followers: realFollowers,
            following: realFollowing
        });
    }

    document.getElementById('profileName').textContent = userData.username;
    document.getElementById('profileUsername').textContent = `@${userData.username}`;
    document.getElementById('profileFollowing').textContent = realFollowing;
    document.getElementById('profileFollowers').textContent = realFollowers;
    document.getElementById('profileLikes').textContent = userData.likes || 0;
    
    if (userData.avatar) {
        document.getElementById('profileAvatar').src = userData.avatar;
    }

    // Cargar videos del usuario
    const videosSnapshot = await db.ref('videos').orderByChild('userId').equalTo(currentUser.uid).once('value');
    const profileVideos = document.getElementById('profileVideos');
    profileVideos.innerHTML = '';

    videosSnapshot.forEach(child => {
        const video = child.val();
        const videoThumb = document.createElement('div');
        videoThumb.className = 'profile-video-thumb';
        videoThumb.dataset.videoId = child.key;
        videoThumb.innerHTML = `
    <video src="${video.videoUrl}"></video>
    <div class="views">${video.views || 0} views</div>
    <div class="delete-video-btn" data-video-id="${child.key}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
    </div>
`;

// Agregar evento para eliminar
const deleteBtn = videoThumb.querySelector('.delete-video-btn');
deleteBtn.addEventListener('click', async (e) => {
    e.stopPropagation();
    showConfirmModal(
        '¿Eliminar video?',
        'Esta acción no se puede deshacer',
        async () => {
            await db.ref('videos/' + child.key).remove();
            loadProfile();
            alert('Video eliminado');
        }
    );
});
        
        videoThumb.addEventListener('click', () => {
            goToVideo(child.key);
        });
        
        profileVideos.appendChild(videoThumb);
    });
}

        // Editar perfil
        document.getElementById('editProfileBtn').addEventListener('click', () => {
            document.getElementById('editProfileModal').classList.add('active');
        });

        document.getElementById('closeEditProfile').addEventListener('click', () => {
            document.getElementById('editProfileModal').classList.remove('active');
        });

        document.getElementById('avatarUploadArea').addEventListener('click', () => {
            document.getElementById('avatarInput').click();
        });

        let selectedAvatar = null;
        document.getElementById('avatarInput').addEventListener('change', (e) => {
            selectedAvatar = e.target.files[0];
            if (selectedAvatar) {
                document.querySelector('#avatarUploadArea p').textContent = 'Imagen seleccionada';
            }
        });

        document.getElementById('saveProfileBtn').addEventListener('click', async () => {
            const name = document.getElementById('editName').value;
            const updates = {};

            if (name) updates.username = name;

            if (selectedAvatar) {
                // Convertir imagen a Base64
                const avatarBase64 = await fileToBase64(selectedAvatar);
                updates.avatar = avatarBase64;
            }

            await db.ref('users/' + currentUser.uid).update(updates);
            document.getElementById('editProfileModal').classList.remove('active');
            document.getElementById('editName').value = '';
            selectedAvatar = null;
            document.querySelector('#avatarUploadArea p').textContent = 'Cambiar foto de perfil';
            loadProfile();
            alert('Perfil actualizado');
        });

        // Función para contar seguidores reales
async function getFollowersCount(userId) {
    const snapshot = await db.ref(`followers/${userId}`).once('value');
    return snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
}

// Función para contar siguiendo reales
async function getFollowingCount(userId) {
    const snapshot = await db.ref(`following/${userId}`).once('value');
    return snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
}

// Función para sincronizar contadores (llamar si hay inconsistencias)
async function syncFollowCounts(userId) {
    const followersCount = await getFollowersCount(userId);
    const followingCount = await getFollowingCount(userId);
    
    await db.ref(`users/${userId}`).update({
        followers: followersCount,
        following: followingCount
    });
    
    console.log(`Sincronizados contadores para ${userId}: ${followersCount} followers, ${followingCount} following`);
}

        // Cargar amigos
        
        // Sistema de chat básico
        function loadChats() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '<div class="loading">Cargando chats...</div>';
            
            // Cargar lista de usuarios con los que has chateado o todos los usuarios
            loadFriends();
        }

        // Función para ir a un video específico
function goToVideo(videoId) {
    // Cerrar perfil si está abierto
    document.getElementById('userProfileView').classList.remove('active');
    
    // Ir a la sección de inicio
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.nav-item')[0].classList.add('active');
    
    document.getElementById('videoFeed').style.display = 'block';
    document.getElementById('profileSection').classList.remove('active');
    document.getElementById('friendsSection').classList.remove('active');
    document.getElementById('chatSection').classList.remove('active');
    document.getElementById('settingsSection').classList.remove('active');
    
    // Buscar el video en el feed
    setTimeout(() => {
        const videoContainer = document.querySelector(`[data-video-id="${videoId}"]`);
        if (videoContainer) {
            // Hacer scroll al video
            videoContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Reproducir el video
            const videoPlayer = videoContainer.querySelector('.video-player');
            if (videoPlayer) {
                videoPlayer.play();
            }
        } else {
            // Si el video no está cargado, recargar el feed
            loadVideos().then(() => {
                setTimeout(() => {
                    const videoContainer = document.querySelector(`[data-video-id="${videoId}"]`);
                    if (videoContainer) {
                        videoContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        const videoPlayer = videoContainer.querySelector('.video-player');
                        if (videoPlayer) {
                            videoPlayer.play();
                        }
                    }
                }, 500);
            });
        }
    }, 300);
}

        // Inicializar PeerJS
        function initializePeer() {
            peer = new Peer(currentUser.uid);
            
            peer.on('open', (id) => {
                console.log('Mi peer ID:', id);
                // Guardar peer ID en Firebase
                db.ref(`users/${currentUser.uid}/peerId`).set(id);
            });

            peer.on('call', (call) => {
                // Recibir llamada
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then((stream) => {
                        localStream = stream;
                        document.getElementById('localVideo').srcObject = stream;
                        
                        call.answer(stream);
                        
                        call.on('stream', (remoteStream) => {
                            document.getElementById('remoteVideo').srcObject = remoteStream;
                            document.getElementById('videoCallContainer').classList.add('active');
                            document.getElementById('videoCallStatus').textContent = 'Conectado';
                        });
                        
                        currentCall = call;
                    })
                    .catch((err) => {
                        console.error('Error al acceder a la cámara:', err);
                        alert('No se pudo acceder a la cámara y micrófono');
                    });
            });
        }

        // Hacer videollamada
        document.getElementById('videoCallBtn').addEventListener('click', async () => {
            if (!currentChatUser) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;

                // Obtener peer ID del otro usuario
                const peerSnapshot = await db.ref(`users/${currentChatUser}/peerId`).once('value');
                const remotePeerId = peerSnapshot.val();

                if (!remotePeerId) {
                    alert('El usuario no está disponible para videollamadas');
                    return;
                }

                const call = peer.call(remotePeerId, stream);
                currentCall = call;

                call.on('stream', (remoteStream) => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    document.getElementById('videoCallContainer').classList.add('active');
                    document.getElementById('videoCallStatus').textContent = 'Conectado';
                });

                // Mostrar nombre del usuario
                const userSnapshot = await db.ref(`users/${currentChatUser}`).once('value');
                const userData = userSnapshot.val();
                document.getElementById('videoCallName').textContent = userData.username;

            } catch (err) {
                console.error('Error al iniciar llamada:', err);
                alert('No se pudo acceder a la cámara y micrófono');
            }
        });

        // Finalizar llamada
        document.getElementById('endCallBtn').addEventListener('click', () => {
            if (currentCall) {
                currentCall.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            document.getElementById('videoCallContainer').classList.remove('active');
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
        });

        // Mutear/desmutear
        document.getElementById('muteBtn').addEventListener('click', () => {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                document.getElementById('muteBtn').style.background = audioTrack.enabled ? '#333' : '#fe2c55';
            }
        });

        // Activar/desactivar video
        document.getElementById('videoToggleBtn').addEventListener('click', () => {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                document.getElementById('videoToggleBtn').style.background = videoTrack.enabled ? '#333' : '#fe2c55';
            }
        });

        // Mejorar el sistema de chat para seleccionar usuario
        async function loadFriends() {
    const usersSnapshot = await db.ref('users').once('value');
    const friendsList = document.getElementById('friendsList');
    const chatList = document.getElementById('chatList');
    friendsList.innerHTML = '';
    chatList.innerHTML = '';

    for (const child of usersSnapshot.val() ? Object.entries(usersSnapshot.val()) : []) {
        const [userId, user] = child;
        
        if (userId !== currentUser.uid) {
            // Verificar si ya sigue al usuario
            const followingSnapshot = await db.ref(`following/${currentUser.uid}/${userId}`).once('value');
            const isFollowing = followingSnapshot.exists();
            
            // Lista de amigos
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.innerHTML = `
                <img class="avatar" src="${user.avatar || ''}" alt="Avatar" />
                <div class="user-info">
                    <div class="user-name">${user.username}</div>
                    <div class="user-username">@${user.username}</div>
                </div>
                <button class="follow-btn ${isFollowing ? 'following' : ''}" data-user="${userId}">
                    ${isFollowing ? 'Siguiendo' : 'Seguir'}
                </button>
            `;
            friendsList.appendChild(userItem);

            const followBtn = userItem.querySelector('.follow-btn');
            followBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                if (followBtn.classList.contains('following')) {
                    // Dejar de seguir
                    followBtn.classList.remove('following');
                    followBtn.textContent = 'Seguir';
                    
                    // Eliminar relaciones
                    await db.ref(`followers/${userId}/${currentUser.uid}`).remove();
                    await db.ref(`following/${currentUser.uid}/${userId}`).remove();
                    
                    // ✅ ACTUALIZAR CONTADORES
                    // Decrementar followers del usuario que dejamos de seguir
                    const targetUserSnapshot = await db.ref(`users/${userId}`).once('value');
                    const targetUser = targetUserSnapshot.val();
                    const newFollowers = Math.max(0, (targetUser.followers || 0) - 1);
                    await db.ref(`users/${userId}/followers`).set(newFollowers);
                    
                    // Decrementar following del usuario actual
                    const currentUserSnapshot = await db.ref(`users/${currentUser.uid}`).once('value');
                    const currentUserData = currentUserSnapshot.val();
                    const newFollowing = Math.max(0, (currentUserData.following || 0) - 1);
                    await db.ref(`users/${currentUser.uid}/following`).set(newFollowing);
                    
                } else {
                    // Seguir
                    followBtn.classList.add('following');
                    followBtn.textContent = 'Siguiendo';
                    
                    // Crear relaciones
                    await db.ref(`followers/${userId}/${currentUser.uid}`).set(true);
                    await db.ref(`following/${currentUser.uid}/${userId}`).set(true);
                    
                    // ✅ ACTUALIZAR CONTADORES
                    // Incrementar followers del usuario que seguimos
                    const targetUserSnapshot = await db.ref(`users/${userId}`).once('value');
                    const targetUser = targetUserSnapshot.val();
                    const newFollowers = (targetUser.followers || 0) + 1;
                    await db.ref(`users/${userId}/followers`).set(newFollowers);
                    
                    // Incrementar following del usuario actual
                    const currentUserSnapshot = await db.ref(`users/${currentUser.uid}`).once('value');
                    const currentUserData = currentUserSnapshot.val();
                    const newFollowing = (currentUserData.following || 0) + 1;
                    await db.ref(`users/${currentUser.uid}/following`).set(newFollowing);
                    
                    // Enviar notificación
                    await sendFollowNotification(userId);
                }
            });

            // Hacer clic en el item para ver perfil
            userItem.addEventListener('click', (e) => {
                if (!e.target.classList.contains('follow-btn')) {
                    openUserProfile(userId);
                }
            });

            // Lista de chats
            const chatItem = document.createElement('div');
            chatItem.className = 'user-item';
            chatItem.innerHTML = `
                <img class="avatar" src="${user.avatar || ''}" alt="Avatar" />
                <div class="user-info">
                    <div class="user-name">${user.username}</div>
                    <div class="user-username">Click para chatear</div>
                </div>
            `;
            chatList.appendChild(chatItem);

            chatItem.addEventListener('click', () => {
                currentChatUser = userId;
                document.getElementById('chatWindow').style.display = 'flex';
                document.getElementById('chatList').style.display = 'none';
                loadMessages(userId);
            });
        }
    }
}

        // Cargar mensajes
        function loadMessages(userId) {
            const chatId = [currentUser.uid, userId].sort().join('_');
            const messagesRef = db.ref(`chats/${chatId}/messages`);
            
            messagesRef.on('value', (snapshot) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                snapshot.forEach(child => {
                    const message = child.val();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.senderId === currentUser.uid ? 'own' : ''}`;
                    messageDiv.innerHTML = `
                        <img class="avatar" src="${message.avatar || ''}" alt="Avatar" />
                        <div class="message-content">${message.text}</div>
                    `;
                    messagesDiv.appendChild(messageDiv);
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // Enviar mensaje
        document.getElementById('sendMessage').addEventListener('click', async () => {
            const messageInput = document.getElementById('messageInput');
            const text = messageInput.value.trim();
            
            if (text && currentChatUser) {
                const chatId = [currentUser.uid, currentChatUser].sort().join('_');
                const userSnapshot = await db.ref(`users/${currentUser.uid}`).once('value');
                const userData = userSnapshot.val();
                
                await db.ref(`chats/${chatId}/messages`).push({
                    senderId: currentUser.uid,
                    text: text,
                    avatar: userData.avatar || '',
                    timestamp: Date.now()
                });
                
                messageInput.value = '';
            }
        });

        // Enter para enviar mensaje
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessage').click();
            }
        });

        // Función para mostrar modal de confirmación
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            
            const acceptBtn = document.getElementById('confirmAccept');
            const cancelBtn = document.getElementById('confirmCancel');
            
            // Limpiar eventos anteriores
            const newAcceptBtn = acceptBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            // Agregar nuevos eventos
            newAcceptBtn.addEventListener('click', () => {
                document.getElementById('confirmModal').classList.remove('active');
                onConfirm();
            });
            
            newCancelBtn.addEventListener('click', () => {
                document.getElementById('confirmModal').classList.remove('active');
            });
        }

        // Información de cuenta
        document.getElementById('accountInfoBtn').addEventListener('click', async () => {
            const userSnapshot = await db.ref('users/' + currentUser.uid).once('value');
            const userData = userSnapshot.val();
            alert('Email: ' + currentUser.email + '\nUsuario: ' + userData.username + '\nUID: ' + currentUser.uid);
        });

        // Cerrar sesión
        document.getElementById('logoutBtn').addEventListener('click', () => {
            showConfirmModal(
                '¿Cerrar sesión?',
                '¿Estás seguro de que quieres salir de tu cuenta?',
                async () => {
                    try {
                        // Cerrar peer
                        if (peer) {
                            peer.destroy();
                        }
                        
                        // Cerrar streams
                        if (localStream) {
                            localStream.getTracks().forEach(track => track.stop());
                        }
                        
                        await auth.signOut();
                        alert('Sesión cerrada correctamente');
                    } catch (error) {
                        alert('Error al cerrar sesión: ' + error.message);
                    }
                }
            );
        });

        // Buscar usuarios en tiempo real
        document.getElementById('friendsSearch').addEventListener('input', async (e) => {
            const query = e.target.value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }

            const usersSnapshot = await db.ref('users').once('value');
            searchResults.innerHTML = '';
            
            let found = false;
            usersSnapshot.forEach(child => {
                if (child.key !== currentUser.uid) {
                    const user = child.val();
                    const username = (user.username || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    
                    if (username.includes(query) || email.includes(query)) {
                        found = true;
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.style.margin = '0';
                        userItem.style.borderRadius = '0';
                        userItem.innerHTML = '<img class="avatar" src="' + (user.avatar || '') + '" alt="Avatar" /><div class="user-info"><div class="user-name">' + user.username + '</div><div class="user-username">@' + user.username + '</div></div>';
                        
                        userItem.addEventListener('click', () => {
                            openUserProfile(child.key);
                            searchResults.innerHTML = '';
                            document.getElementById('friendsSearch').value = '';
                        });
                        
                        searchResults.appendChild(userItem);
                    }
                }
            });
            
            if (!found && query) {
                searchResults.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No se encontraron usuarios</div>';
            }
        });

        // Búsqueda desde la barra superior
        document.getElementById('openSearchBtn').addEventListener('click', () => {
            document.getElementById('globalSearchBar').style.display = 'block';
            document.getElementById('globalSearch').focus();
        });

        document.getElementById('closeGlobalSearch').addEventListener('click', () => {
            document.getElementById('globalSearchBar').style.display = 'none';
            document.getElementById('globalSearch').value = '';
            document.getElementById('globalSearchResults').innerHTML = '';
        });

        // Búsqueda global en tiempo real
        document.getElementById('globalSearch').addEventListener('input', async (e) => {
            const query = e.target.value.toLowerCase().trim();
            const searchResults = document.getElementById('globalSearchResults');
            
            if (!query) {
                searchResults.innerHTML = '';
                return;
            }

            const usersSnapshot = await db.ref('users').once('value');
            searchResults.innerHTML = '';
            
            let found = false;
            usersSnapshot.forEach(child => {
                if (child.key !== currentUser.uid) {
                    const user = child.val();
                    const username = (user.username || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    
                    if (username.includes(query) || email.includes(query)) {
                        found = true;
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.style.margin = '0';
                        userItem.style.borderRadius = '0';
                        userItem.innerHTML = '<img class="avatar" src="' + (user.avatar || '') + '" alt="Avatar" /><div class="user-info"><div class="user-name">' + user.username + '</div><div class="user-username">@' + user.username + '</div></div>';
                        
                        userItem.addEventListener('click', () => {
                            openUserProfile(child.key);
                            document.getElementById('globalSearchBar').style.display = 'none';
                            document.getElementById('globalSearch').value = '';
                            searchResults.innerHTML = '';
                        });
                        
                        searchResults.appendChild(userItem);
                    }
                }
            });
            
            if (!found && query) {
                searchResults.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No se encontraron usuarios</div>';
            }
        });

        // Función para abrir perfil de usuario
        async function openUserProfile(userId) {
    currentViewingUserId = userId;
    const userSnapshot = await db.ref('users/' + userId).once('value');
    const userData = userSnapshot.val();

    // ✅ SINCRONIZAR CONTADORES
    const realFollowers = await getFollowersCount(userId);
    const realFollowing = await getFollowingCount(userId);

    document.getElementById('viewProfileName').textContent = userData.username;
    document.getElementById('viewProfileUsername').textContent = '@' + userData.username;
    document.getElementById('viewProfileFollowing').textContent = realFollowing;
    document.getElementById('viewProfileFollowers').textContent = realFollowers;
    document.getElementById('viewProfileLikes').textContent = userData.likes || 0;
    
    if (userData.avatar) {
        document.getElementById('viewProfileAvatar').src = userData.avatar;
    } else {
        document.getElementById('viewProfileAvatar').src = '';
    }

    // Verificar si ya sigue al usuario
    const followingSnapshot = await db.ref('following/' + currentUser.uid + '/' + userId).once('value');
    const isFollowing = followingSnapshot.exists();
    
    const followBtn = document.getElementById('followUserBtn');
    if (isFollowing) {
        followBtn.textContent = 'Siguiendo';
        followBtn.classList.remove('primary');
        followBtn.classList.add('secondary');
        followBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>Siguiendo';
    } else {
        followBtn.textContent = 'Seguir';
        followBtn.classList.add('primary');
        followBtn.classList.remove('secondary');
        followBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>Seguir';
    }

    // Cargar videos del usuario
    const videosSnapshot = await db.ref('videos').orderByChild('userId').equalTo(userId).once('value');
    const viewProfileVideos = document.getElementById('viewProfileVideos');
    viewProfileVideos.innerHTML = '';

    videosSnapshot.forEach(child => {
        const video = child.val();
        const videoThumb = document.createElement('div');
        videoThumb.className = 'profile-video-thumb';
        videoThumb.dataset.videoId = child.key;
        videoThumb.innerHTML = '<video src="' + video.videoUrl + '"></video><div class="views">' + (video.views || 0) + ' views</div>';
        
        videoThumb.addEventListener('click', () => {
            goToVideo(child.key);
        });
        
        viewProfileVideos.appendChild(videoThumb);
    });

    document.getElementById('userProfileView').classList.add('active');
}

        // Cerrar perfil de usuario
        document.getElementById('closeUserProfile').addEventListener('click', () => {
            document.getElementById('userProfileView').classList.remove('active');
            currentViewingUserId = null;
        });

        // Seguir/Dejar de seguir usuario
        // Seguir/Dejar de seguir usuario
document.getElementById('followUserBtn').addEventListener('click', async () => {
    if (!currentViewingUserId) return;
    
    const followBtn = document.getElementById('followUserBtn');
    const followingSnapshot = await db.ref(`following/${currentUser.uid}/${currentViewingUserId}`).once('value');
    const isFollowing = followingSnapshot.exists();
    
    if (isFollowing) {
        // Dejar de seguir
        await db.ref(`followers/${currentViewingUserId}/${currentUser.uid}`).remove();
        await db.ref(`following/${currentUser.uid}/${currentViewingUserId}`).remove();
        
        // ✅ ACTUALIZAR CONTADORES
        // Decrementar followers del usuario que dejamos de seguir
        const targetUserSnapshot = await db.ref(`users/${currentViewingUserId}`).once('value');
        const targetUser = targetUserSnapshot.val();
        const newFollowers = Math.max(0, (targetUser.followers || 0) - 1);
        await db.ref(`users/${currentViewingUserId}/followers`).set(newFollowers);
        
        // Decrementar following del usuario actual
        const currentUserSnapshot = await db.ref(`users/${currentUser.uid}`).once('value');
        const currentUserData = currentUserSnapshot.val();
        const newFollowing = Math.max(0, (currentUserData.following || 0) - 1);
        await db.ref(`users/${currentUser.uid}/following`).set(newFollowing);
        
        // Actualizar UI
        followBtn.classList.add('primary');
        followBtn.classList.remove('secondary');
        followBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>Seguir';
        
        // Actualizar contador en la vista
        document.getElementById('viewProfileFollowers').textContent = newFollowers;
        
    } else {
        // Seguir
        await db.ref(`followers/${currentViewingUserId}/${currentUser.uid}`).set(true);
        await db.ref(`following/${currentUser.uid}/${currentViewingUserId}`).set(true);
        
        // ✅ ACTUALIZAR CONTADORES
        // Incrementar followers del usuario que seguimos
        const targetUserSnapshot = await db.ref(`users/${currentViewingUserId}`).once('value');
        const targetUser = targetUserSnapshot.val();
        const newFollowers = (targetUser.followers || 0) + 1;
        await db.ref(`users/${currentViewingUserId}/followers`).set(newFollowers);
        
        // Incrementar following del usuario actual
        const currentUserSnapshot = await db.ref(`users/${currentUser.uid}`).once('value');
        const currentUserData = currentUserSnapshot.val();
        const newFollowing = (currentUserData.following || 0) + 1;
        await db.ref(`users/${currentUser.uid}/following`).set(newFollowing);
        
        // Actualizar UI
        followBtn.classList.remove('primary');
        followBtn.classList.add('secondary');
        followBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>Siguiendo';
        
        // Actualizar contador en la vista
        document.getElementById('viewProfileFollowers').textContent = newFollowers;
        
        // Enviar notificación
        await sendFollowNotification(currentViewingUserId);
    }
});

        // Chatear con usuario - VERIFICAR QUE EL BOTÓN EXISTE
        // Chatear con usuario - ARREGLADO
document.getElementById('chatUserBtn').addEventListener('click', () => {
    if (!currentViewingUserId) {
        alert('Error: No se pudo identificar al usuario');
        return;
    }
    
    // Cerrar vista de perfil
    document.getElementById('userProfileView').classList.remove('active');
    
    // Ir a la sección de chat
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector('[data-section="chat"]').classList.add('active');
    
    document.getElementById('videoFeed').style.display = 'none';
    document.getElementById('profileSection').classList.remove('active');
    document.getElementById('friendsSection').classList.remove('active');
    document.getElementById('chatSection').classList.add('active');
    document.getElementById('settingsSection').classList.remove('active');
    
    // Abrir chat
    currentChatUser = currentViewingUserId;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatList').style.display = 'none';
    loadMessages(currentViewingUserId);
});

        // Eliminar cuenta
        document.getElementById('deleteAccountBtn').addEventListener('click', () => {
            showConfirmModal(
                '⚠️ ¿Eliminar cuenta?',
                'Esta acción es PERMANENTE. Se eliminarán todos tus videos, mensajes y datos. No se puede deshacer.',
                async () => {
                    try {
                        const userId = currentUser.uid;
                        
                        // Eliminar todos los datos del usuario
                        await db.ref('users/' + userId).remove();
                        
                        // Eliminar videos del usuario
                        const videosSnapshot = await db.ref('videos').orderByChild('userId').equalTo(userId).once('value');
                        videosSnapshot.forEach(child => {
                            db.ref('videos/' + child.key).remove();
                        });
                        
                        // Eliminar seguidores y seguidos
                        await db.ref('followers/' + userId).remove();
                        await db.ref('following/' + userId).remove();
                        
                        // Eliminar peer
                        if (peer) {
                            peer.destroy();
                        }
                        
                        // Eliminar cuenta de Firebase Auth
                        await currentUser.delete();
                        
                        alert('Cuenta eliminada correctamente');
                    } catch (error) {
                        if (error.code === 'auth/requires-recent-login') {
                            alert('Por seguridad, necesitas volver a iniciar sesión antes de eliminar tu cuenta.');
                        } else {
                            alert('Error al eliminar cuenta: ' + error.message);
                        }
                    }
                }
            );
        });

        // Inicializar
        document.getElementById('authUsername').style.display = 'none';

        // Prevenir errores si algunos elementos no existen aún
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM completamente cargado');
        });

        // Variables para tipo de video
let selectedVideoType = 'short'; // short o long

// Selector de tipo de video
document.querySelectorAll('.video-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.video-type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedVideoType = btn.dataset.type;
    });
});

// Navegación del sidebar
document.querySelectorAll('.sidebar-item').forEach(item => {
    item.addEventListener('click', () => {
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        const section = item.dataset.section;
        
        // Ocultar todas las secciones
        document.getElementById('videoFeed').style.display = 'none';
        document.getElementById('profileSection').classList.remove('active');
        document.getElementById('friendsSection').classList.remove('active');
        document.getElementById('chatSection').classList.remove('active');
        document.getElementById('settingsSection').classList.remove('active');
        
        // Mostrar sección correspondiente
        if (section === 'feed') {
            document.getElementById('videoFeed').style.display = 'block';
            document.getElementById('videoFeed').className = 'video-feed mixed-mode';
            loadMixedVideos();
        } else if (section === 'shorts') {
            document.getElementById('videoFeed').style.display = 'block';
            document.getElementById('videoFeed').className = 'video-feed shorts-mode';
            loadShorts();
        } else if (section === 'longs') {
            document.getElementById('videoFeed').style.display = 'block';
            document.getElementById('videoFeed').className = 'video-feed longs-mode';
            loadLongs();
        } else if (section === 'profile') {
            document.getElementById('profileSection').classList.add('active');
            loadProfile();
        } else if (section === 'friends') {
            document.getElementById('friendsSection').classList.add('active');
            loadFriends();
        } else if (section === 'chat') {
            document.getElementById('chatSection').classList.add('active');
            loadChats();
        } else if (section === 'settings') {
            document.getElementById('settingsSection').classList.add('active');
        }
    });
});

// Cargar videos mixtos (shorts + longs)
async function loadMixedVideos() {
    const videosRef = db.ref('videos').orderByChild('timestamp');
    const snapshot = await videosRef.once('value');
    const videos = [];
    
    snapshot.forEach(child => {
        videos.push({ id: child.key, ...child.val() });
    });
    
    videos.reverse();
    
    const videoFeed = document.getElementById('videoFeed');
    videoFeed.innerHTML = '';
    
    for (const video of videos) {
        const userSnapshot = await db.ref(`users/${video.userId}`).once('value');
        const user = userSnapshot.val();
        
        const isLong = video.type === 'long';
        
        if (isLong) {
            // Mostrar como video horizontal
            const longContainer = document.createElement('div');
            longContainer.className = 'long-video-container';
            longContainer.innerHTML = `
                <video class="long-video-thumbnail" src="${video.videoUrl}" muted></video>
                <div class="long-video-info">
                    <div class="long-video-title">${video.title || 'Sin título'}</div>
                    <div class="long-video-author">
                        <img src="${user?.avatar || ''}" alt="Avatar" />
                        <span>${user?.username || 'Usuario'}</span>
                    </div>
                    <div class="long-video-stats">${video.views || 0} vistas • ${video.likes || 0} likes</div>
                </div>
            `;
            
            longContainer.addEventListener('click', () => {
                goToVideo(video.id);
            });
            
            videoFeed.appendChild(longContainer);
        } else {
            // Mostrar como short
            const mixedContainer = document.createElement('div');
            mixedContainer.className = 'mixed-video-container short';
            mixedContainer.dataset.videoId = video.id;
            
            mixedContainer.innerHTML = `
                <video class="video-player" src="${video.videoUrl}" controls></video>
                <div style="padding: 15px;">
                    ${video.title ? `<div class="video-title">${video.title}</div>` : ''}
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <img src="${user?.avatar || ''}" style="width: 40px; height: 40px; border-radius: 50%;" />
                        <div>
                            <div style="font-weight: bold;">${user?.username || 'Usuario'}</div>
                            <div style="font-size: 13px; opacity: 0.6;">${video.views || 0} vistas</div>
                        </div>
                    </div>
                </div>
            `;
            
            videoFeed.appendChild(mixedContainer);
        }
    }
}

// Cargar solo shorts
async function loadShorts() {
    const videosRef = db.ref('videos').orderByChild('type').equalTo('short');
    const snapshot = await videosRef.once('value');
    
    if (!snapshot.exists()) {
        // Si no hay videos filtrados por tipo, cargar todos los verticales
        loadVideos();
        return;
    }
    
    const videos = [];
    snapshot.forEach(child => {
        videos.push({ id: child.key, ...child.val() });
    });
    
    videos.reverse();
    
    const videoFeed = document.getElementById('videoFeed');
    videoFeed.innerHTML = '';
    
    for (const video of videos) {
        // Crear short similar a loadVideos pero solo shorts
        // Usar el mismo código de loadVideos() aquí
    }
}

// Cargar solo longs
async function loadLongs() {
    const videosRef = db.ref('videos').orderByChild('type').equalTo('long');
    const snapshot = await videosRef.once('value');
    const videos = [];
    
    snapshot.forEach(child => {
        videos.push({ id: child.key, ...child.val() });
    });
    
    videos.reverse();
    
    const videoFeed = document.getElementById('videoFeed');
    videoFeed.innerHTML = '';
    
    for (const video of videos) {
        const userSnapshot = await db.ref(`users/${video.userId}`).once('value');
        const user = userSnapshot.val();
        
        const longContainer = document.createElement('div');
        longContainer.className = 'long-video-container';
        longContainer.innerHTML = `
            <video class="long-video-thumbnail" src="${video.videoUrl}" muted></video>
            <div class="long-video-info">
                <div class="long-video-title">${video.title || 'Sin título'}</div>
                <div class="long-video-author">
                    <img src="${user?.avatar || ''}" alt="Avatar" />
                    <span>${user?.username || 'Usuario'}</span>
                </div>
                <div class="long-video-stats">${video.views || 0} vistas • ${video.likes || 0} likes</div>
            </div>
        `;
        
        longContainer.addEventListener('click', () => {
            goToVideo(video.id);
        });
        
        videoFeed.appendChild(longContainer);
    }
}
    </script>
</body>
</html>
